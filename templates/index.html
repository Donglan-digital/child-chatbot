<!DOCTYPE html>
<html>
<head>
    <title>Child Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
</head>
<body>
    <h1>小朋友，跟我练习普通话吧！</h1>
    <button id="startBtn">开始说话</button>
    <button id="stopBtn" disabled>结束说话</button>
    <p id="status">点击“开始说话”按钮开始录音，点击“结束说话”按钮结束录音</p>
    <p id="result"></p>

    <script>
        let recognizer;
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const statusText = document.getElementById("status");
        const resultText = document.getElementById("result");

        // 从后端获取Azure配置
        async function getAzureConfig() {
            const response = await fetch("/get-azure-config");
            return await response.json();
        }

        // 初始化语音识别
        async function initializeRecognizer() {
            const config = await getAzureConfig();
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.key, config.region);
            speechConfig.speechRecognitionLanguage = "zh-CN"; // 设置语言为中文
            recognizer = new SpeechSDK.SpeechRecognizer(speechConfig);
            console.log("Recognizer initialized");

            // 设置事件处理程序
            recognizer.recognized = (s, e) => {
                if (e.result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                    resultText.innerText = `你说：${e.result.text}`;
                    console.log(`Recognized: ${e.result.text}`);
                    sendToBackend(e.result.text); // 发送到后端
                } else {
                    statusText.innerText = "识别失败，请重试";
                    console.log("Recognition failed");
                }
            };

            recognizer.canceled = (s, e) => {
                statusText.innerText = `错误：${e.errorDetails}`;
                console.error(`Recognition canceled: ${e.errorDetails}`);
            };
        }

        // 开始录音
        function startListening() {
            statusText.innerText = "正在聆听...";
            console.log("Listening started");
            recognizer.startContinuousRecognitionAsync();
            startBtn.disabled = true;
            stopBtn.disabled = false;
        }

        // 停止录音
        function stopListening() {
            recognizer.stopContinuousRecognitionAsync(
                () => {
                    console.log("Recognition stopped");
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                },
                error => {
                    console.error(`Recognition stop error: ${error}`);
                }
            );
        }

        // 发送语音文本到后端
        async function sendToBackend(text) {
            console.log(`Sending to backend: ${text}`);
            try {
                const response = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text: text })
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                resultText.innerText += `\nAI回复：${data.reply}`;
                console.log(`AI reply: ${data.reply}`);
                speak(data.reply); // 读出AI回复
            } catch (error) {
                console.error(`Error: ${error}`);
                statusText.innerText = `错误：${error.message}`;
            }
        }

        // 使用Web Speech API读出文本
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "zh-CN"; // 设置语言为中文
            window.speechSynthesis.speak(utterance);
            console.log(`Speaking: ${text}`);
        }

        // 初始化
        (async function () {
            await initializeRecognizer();
            startBtn.addEventListener("click", startListening);
            stopBtn.addEventListener("click", stopListening);
        })();
    </script>
</body>
</html>
