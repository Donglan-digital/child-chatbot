<!DOCTYPE html>
<html>
<head>
    <title>Child Chatbot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://aka.ms/csspeech/microsoftcognitivecookies"></script>
    <script src="https://aka.ms/csspeech/speechsdk.js"></script>
</head>
<body>
    <h1>小朋友，跟我练习普通话吧！</h1>
    <button id="startBtn">开始说话</button>
    <p id="status">点击按钮开始录音</p>
    <p id="result"></p>

    <script>
        let recognizer;
        const startBtn = document.getElementById("startBtn");
        const statusText = document.getElementById("status");
        const resultText = document.getElementById("result");

        // 从后端获取Azure配置
        async function getAzureConfig() {
            const response = await fetch("/get-azure-config");
            return await response.json();
        }

        // 初始化语音识别
        async function initializeRecognizer() {
            const config = await getAzureConfig();
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(config.key, config.region);
            speechConfig.speechRecognitionLanguage = "zh-CN"; // 设置语言为中文
            recognizer = new SpeechSDK.SpeechRecognizer(speechConfig);
        }

        // 开始录音
        async function startListening() {
            statusText.innerText = "正在聆听...";
            recognizer.recognizeOnceAsync(
                result => {
                    if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech) {
                        resultText.innerText = `你说：${result.text}`;
                        sendToBackend(result.text); // 发送到后端
                    } else {
                        statusText.innerText = "识别失败，请重试";
                    }
                },
                error => {
                    statusText.innerText = `错误：${error}`;
                }
            );
        }

        // 发送语音文本到后端
        async function sendToBackend(text) {
            const response = await fetch("/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: text })
            });
            const data = await response.json();
            resultText.innerText += `\nAI回复：${data.reply}`;
            speak(data.reply); // 读出AI回复
        }

        // 使用Web Speech API读出文本
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = "zh-CN"; // 设置语言为中文
            window.speechSynthesis.speak(utterance);
        }

        // 初始化
        (async function () {
            await initializeRecognizer();
            startBtn.addEventListener("click", startListening);
        })();
    </script>
</body>
</html>
